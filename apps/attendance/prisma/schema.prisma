datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["attendance"]
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

/// Work Schedule Definitions (جداول الدوام)
model WorkSchedule {
  id          String  @id @default(uuid())
  code        String  @unique
  nameAr      String
  nameEn      String?
  description String?

  // Work hours (format: "HH:mm")
  workStartTime    String
  workEndTime      String
  breakStartTime   String?
  breakEndTime     String?
  breakDurationMin Int     @default(60)

  // Work days as JSON array (0=Sunday, 6=Saturday)
  // Example: "[0,1,2,3,4]" for Sunday-Thursday
  workDays String @default("[0,1,2,3,4]")

  // Tolerance settings (minutes)
  lateToleranceMin       Int @default(15)
  earlyLeaveToleranceMin Int @default(15)

  // Overtime settings
  allowOvertime    Boolean @default(false)
  maxOvertimeHours Float?

  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employeeSchedules EmployeeSchedule[]
  customSchedules   CustomWorkSchedule[]

  @@map("work_schedules")
  @@schema("attendance")
}

/// Employee Schedule Assignment (تعيين الجدول للموظف)
model EmployeeSchedule {
  id            String    @id @default(uuid())
  employeeId    String
  scheduleId    String
  effectiveFrom DateTime
  effectiveTo   DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  schedule WorkSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([employeeId, scheduleId, effectiveFrom])
  @@index([employeeId])
  @@index([scheduleId])
  @@map("employee_schedules")
  @@schema("attendance")
}

/// Custom/Temporary Work Schedules (جداول مؤقتة مثل رمضان)
model CustomWorkSchedule {
  id          String  @id @default(uuid())
  scheduleId  String
  nameAr      String
  nameEn      String?
  description String?

  // Override work hours
  workStartTime  String
  workEndTime    String
  breakStartTime String?
  breakEndTime   String?

  // Period
  startDate DateTime
  endDate   DateTime

  // Optional: specific employee IDs (null means all employees)
  // JSON array of employee IDs or null
  employeeIds String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schedule WorkSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([startDate, endDate])
  @@map("custom_work_schedules")
  @@schema("attendance")
}

/// Attendance Records (سجلات الحضور)
model AttendanceRecord {
  id         String   @id @default(uuid())
  employeeId String
  date       DateTime @db.Date

  // Clock times
  clockInTime  DateTime?
  clockOutTime DateTime?

  // Calculated fields
  workedMinutes   Int?
  overtimeMinutes Int?
  breakMinutes    Int?

  // Status: PRESENT, ABSENT, LATE, EARLY_LEAVE, HALF_DAY, ON_LEAVE, HOLIDAY, WEEKEND
  status String @default("PRESENT")

  // Late/Early metrics (in minutes)
  lateMinutes       Int @default(0)
  earlyLeaveMinutes Int @default(0)

  // Location data (optional) - JSON format
  clockInLocation  String?
  clockOutLocation String?

  // Device/IP info
  clockInIp  String?
  clockOutIp String?

  // Manual entry/correction
  isManualEntry     Boolean @default(false)
  manualEntryBy     String?
  manualEntryReason String?

  // Approval for manual entries
  approvalStatus String? // PENDING, APPROVED, REJECTED
  approvedBy     String?
  approvedAt     DateTime?
  approvalNotes  String?

  notes     String?

  // Deduction (يُفعَّل عند رفض التبرير أو انتهاء المهلة)
  deductionApplied Boolean @default(false)
  deductionMinutes Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@map("attendance_records")
  @@schema("attendance")
}

/// Attendance Alerts (تنبيهات الحضور)
model AttendanceAlert {
  id         String   @id @default(uuid())
  employeeId String
  date       DateTime @db.Date

  // Alert type: LATE, ABSENT, EARLY_LEAVE, MISSING_CLOCK_OUT, CONSECUTIVE_ABSENCE
  alertType String

  // Severity: LOW, MEDIUM, HIGH, CRITICAL
  severity String @default("MEDIUM")

  // Details
  message   String
  messageAr String?

  // Reference to the attendance record if applicable
  attendanceRecordId String?

  // Status: OPEN, ACKNOWLEDGED, RESOLVED, DISMISSED
  status String @default("OPEN")

  // Resolution
  resolvedBy      String?
  resolvedAt      DateTime?
  resolutionNotes String?

  // Auto-generated or manual
  isAutoGenerated Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  justification AttendanceJustification?

  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([alertType])
  @@map("attendance_alerts")
  @@schema("attendance")
}

/// Attendance Justifications (تبريرات الحضور)
model AttendanceJustification {
  id                 String    @id @default(uuid())
  employeeId         String
  alertId            String    @unique
  attendanceRecordId String?

  // نوع التبرير
  justificationType  String
  // SICK | EMERGENCY | OFFICIAL_MISSION | TRANSPORTATION | OTHER

  descriptionAr      String
  descriptionEn      String?
  attachmentUrl      String?

  // المهلة = alert.createdAt + 24h
  deadline           DateTime

  // حالة التبرير
  status             String    @default("PENDING_MANAGER")
  // PENDING_MANAGER | MANAGER_APPROVED | MANAGER_REJECTED
  // PENDING_HR | HR_APPROVED | HR_REJECTED | AUTO_REJECTED

  // مراجعة المدير
  managerReviewedBy  String?
  managerReviewedAt  DateTime?
  managerNotes       String?
  managerNotesAr     String?

  // مراجعة HR
  hrReviewedBy       String?
  hrReviewedAt       DateTime?
  hrNotes            String?
  hrNotesAr          String?

  // الخصم
  deductionApplied   Boolean   @default(false)
  deductionMinutes   Int?

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  alert              AttendanceAlert @relation(fields: [alertId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([status])
  @@map("attendance_justifications")
  @@schema("attendance")
}

/// Attendance Settings (إعدادات الحضور)
model AttendanceSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("attendance_settings")
  @@schema("attendance")
}
